"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3498],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>u});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},m="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),m=c(n),d=i,u=m["".concat(l,".").concat(d)]||m[d]||h[d]||r;return n?a.createElement(u,s(s({ref:t},p),{},{components:n})):a.createElement(u,s({ref:t},p))}));function u(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,s=new Array(r);s[0]=d;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[m]="string"==typeof e?e:i,s[1]=o;for(var c=2;c<r;c++)s[c]=n[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},58295:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>r,metadata:()=>o,toc:()=>c});var a=n(87462),i=(n(67294),n(3905));const r={title:"Contracts",sidebar_label:"Contracts",sidebar_position:7,slug:"/ibc/light-clients/wasm/contracts"},s="Contracts",o={unversionedId:"light-clients/wasm/contracts",id:"light-clients/wasm/contracts",title:"Contracts",description:"Learn about the expected behaviour of Wasm light client contracts and the between with 08-wasm.",source:"@site/docs/03-light-clients/04-wasm/07-contracts.md",sourceDirName:"03-light-clients/04-wasm",slug:"/ibc/light-clients/wasm/contracts",permalink:"/main/ibc/light-clients/wasm/contracts",draft:!1,tags:[],version:"current",sidebarPosition:7,frontMatter:{title:"Contracts",sidebar_label:"Contracts",sidebar_position:7,slug:"/ibc/light-clients/wasm/contracts"},sidebar:"defaultSidebar",previous:{title:"Events",permalink:"/main/ibc/light-clients/wasm/events"},next:{title:"Client",permalink:"/main/ibc/light-clients/wasm/client"}},l={},c=[{value:"API",id:"api",level:2},{value:"<code>InstantiateMessage</code>",id:"instantiatemessage",level:2},{value:"<code>QueryMsg</code>",id:"querymsg",level:2},{value:"<code>SudoMsg</code>",id:"sudomsg",level:2},{value:"Migration",id:"migration",level:3},{value:"Expected behaviour",id:"expected-behaviour",level:2}],p={toc:c},m="wrapper";function h(e){let{components:t,...n}=e;return(0,i.kt)(m,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"contracts"},"Contracts"),(0,i.kt)("p",null,"Learn about the expected behaviour of Wasm light client contracts and the between with ",(0,i.kt)("inlineCode",{parentName:"p"},"08-wasm"),". {synopsis}"),(0,i.kt)("h2",{id:"api"},"API"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"08-wasm")," light client proxy performs calls to the Wasm light client via the Wasm VM. The calls require as input JSON-encoded payload messages that fall in the three categories described in the next sections. "),(0,i.kt)("h2",{id:"instantiatemessage"},(0,i.kt)("inlineCode",{parentName:"h2"},"InstantiateMessage")),(0,i.kt)("p",null,"This is the message sent to the contract's ",(0,i.kt)("inlineCode",{parentName:"p"},"instantiate")," entry point. It contains the client and consensus state provided in ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/cosmos/ibc-go/blob/v7.2.0/proto/ibc/core/client/v1/tx.proto#L25-L37"},(0,i.kt)("inlineCode",{parentName:"a"},"MsgCreateClient")),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'type InstantiateMessage struct {\n  ClientState    *ClientState    `json:"client_state"`\n  ConsensusState *ConsensusState `json:"consensus_state"`\n}\n')),(0,i.kt)("p",null,"The Wasm light client contract is expected to store the client and consensus state in the corresponding keys of the client-prefixed store."),(0,i.kt)("h2",{id:"querymsg"},(0,i.kt)("inlineCode",{parentName:"h2"},"QueryMsg")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"QueryMsg")," acts as a discriminated union type that is used to encode the messages that are sent to the contract's ",(0,i.kt)("inlineCode",{parentName:"p"},"query")," entry point. Only one of the fields of the type should be set at a time, so that the other fields are omitted in the encoded JSON and the payload can be correctly translated to the corresponding element of the enumeration in Rust."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'type QueryMsg struct {\n  Status               *StatusMsg               `json:"status,omitempty"`\n  ExportMetadata       *ExportMetadataMsg       `json:"export_metadata,omitempty"`\n  TimestampAtHeight    *TimestampAtHeightMsg    `json:"timestamp_at_height,omitempty"`\n  VerifyClientMessage  *VerifyClientMessageMsg  `json:"verify_client_message,omitempty"`\n  CheckForMisbehaviour *CheckForMisbehaviourMsg `json:"check_for_misbehaviour,omitempty"`\n}\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-rust"},"#[cw_serde]\npub enum QueryMsg {\n  Status(StatusMsg),\n  ExportMetadata(ExportMetadataMsg),\n  TimestampAtHeight(TimestampAtHeightMsg),\n  VerifyClientMessage(VerifyClientMessageRaw),\n  CheckForMisbehaviour(CheckForMisbehaviourMsgRaw),\n}\n")),(0,i.kt)("p",null,"To learn what it is expected from the Wasm light client contract when processing each message, please read the corresponsing section of the ",(0,i.kt)("a",{parentName:"p",href:"/main/ibc/light-clients/overview"},"Light client developer guide"),":"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"For ",(0,i.kt)("inlineCode",{parentName:"li"},"StatusMsg"),", see the section ",(0,i.kt)("a",{parentName:"li",href:"/main/ibc/light-clients/client-state#status-method"},(0,i.kt)("inlineCode",{parentName:"a"},"Status")," method"),"."),(0,i.kt)("li",{parentName:"ul"},"For ",(0,i.kt)("inlineCode",{parentName:"li"},"ExportMetadataMsg"),", see the section ",(0,i.kt)("a",{parentName:"li",href:"/main/ibc/light-clients/genesis#genesis-metadata"},"Genesis metadata"),"."),(0,i.kt)("li",{parentName:"ul"},"For ",(0,i.kt)("inlineCode",{parentName:"li"},"TimestampAtHeightMsg"),", see the section ",(0,i.kt)("a",{parentName:"li",href:"/main/ibc/light-clients/client-state#gettimestampatheight-method"},(0,i.kt)("inlineCode",{parentName:"a"},"GetTimestampAtHeight")," method"),"."),(0,i.kt)("li",{parentName:"ul"},"For ",(0,i.kt)("inlineCode",{parentName:"li"},"VerifyClientMessageMsg"),", see the section ",(0,i.kt)("a",{parentName:"li",href:"/main/ibc/light-clients/updates-and-misbehaviour#verifyclientmessage"},(0,i.kt)("inlineCode",{parentName:"a"},"VerifyClientMessage")),"."),(0,i.kt)("li",{parentName:"ul"},"For ",(0,i.kt)("inlineCode",{parentName:"li"},"CheckForMisbehaviourMsg"),", see the section ",(0,i.kt)("a",{parentName:"li",href:"/main/ibc/light-clients/client-state#checkformisbehaviour-method"},(0,i.kt)("inlineCode",{parentName:"a"},"CheckForMisbehaviour")," method"),".")),(0,i.kt)("h2",{id:"sudomsg"},(0,i.kt)("inlineCode",{parentName:"h2"},"SudoMsg")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"SudoMsg")," acts as a discriminated union type that is used to encode the messages that are sent to the contract's ",(0,i.kt)("inlineCode",{parentName:"p"},"sudo")," entry point. Only one of the fields of the type should be set at a time, so that the other fields are omitted in the encoded JSON and the payload can be correctly translated to the corresponding element of the enumeration in Rust."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"sudo")," entry point is able to perform state-changing writes in the client-prefixed store."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'type SudoMsg struct {\n  UpdateState                 *UpdateStateMsg                 `json:"update_state,omitempty"`\n  UpdateStateOnMisbehaviour   *UpdateStateOnMisbehaviourMsg   `json:"update_state_on_misbehaviour,omitempty"`\n  VerifyUpgradeAndUpdateState *VerifyUpgradeAndUpdateStateMsg `json:"verify_upgrade_and_update_state,omitempty"`\n  VerifyMembership            *VerifyMembershipMsg            `json:"verify_membership,omitempty"`\n  VerifyNonMembership         *VerifyNonMembershipMsg         `json:"verify_non_membership,omitempty"`\n  MigrateClientStore          *MigrateClientStoreMsg          `json:"migrate_client_store,omitempty"`\n}\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-rust"},"#[cw_serde]\npub enum SudoMsg {\n  UpdateState(UpdateStateMsgRaw),\n  UpdateStateOnMisbehaviour(UpdateStateOnMisbehaviourMsgRaw),\n  VerifyUpgradeAndUpdateState(VerifyUpgradeAndUpdateStateMsgRaw),\n  VerifyMembership(VerifyMembershipMsgRaw),\n  VerifyNonMembership(VerifyNonMembershipMsgRaw),\n  MigrateClientStore(MigrateClientStoreMsgRaw),\n}\n")),(0,i.kt)("p",null,"To learn what it is expected from the Wasm light client contract when processing each message, please read the corresponsing section of the ",(0,i.kt)("a",{parentName:"p",href:"/main/ibc/light-clients/overview"},"Light client developer guide"),":"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"For ",(0,i.kt)("inlineCode",{parentName:"li"},"UpdateStateMsg"),", see the section ",(0,i.kt)("a",{parentName:"li",href:"/main/ibc/light-clients/updates-and-misbehaviour#updatestate"},(0,i.kt)("inlineCode",{parentName:"a"},"UpdateState")),"."),(0,i.kt)("li",{parentName:"ul"},"For ",(0,i.kt)("inlineCode",{parentName:"li"},"UpdateStateOnMisbehaviourMsg"),", see the section ",(0,i.kt)("a",{parentName:"li",href:"/main/ibc/light-clients/updates-and-misbehaviour#updatestateonmisbehaviour"},(0,i.kt)("inlineCode",{parentName:"a"},"UpdateStateOnMisbehaviour")),"."),(0,i.kt)("li",{parentName:"ul"},"For ",(0,i.kt)("inlineCode",{parentName:"li"},"VerifyUpgradeAndUpdateStateMsg"),", see the section ",(0,i.kt)("a",{parentName:"li",href:"/main/ibc/light-clients/upgrades#implementing-verifyupgradeandupdatestate"},(0,i.kt)("inlineCode",{parentName:"a"},"GetTimestampAtHeight")," method"),"."),(0,i.kt)("li",{parentName:"ul"},"For ",(0,i.kt)("inlineCode",{parentName:"li"},"VerifyMembershipMsg"),", see the section ",(0,i.kt)("a",{parentName:"li",href:"/main/ibc/light-clients/client-state#verifymembership-method"},(0,i.kt)("inlineCode",{parentName:"a"},"VerifyMembership")," method"),"."),(0,i.kt)("li",{parentName:"ul"},"For ",(0,i.kt)("inlineCode",{parentName:"li"},"VerifyNonMembershipMsg"),", see the section ",(0,i.kt)("a",{parentName:"li",href:"/main/ibc/light-clients/client-state#verifynonmembership-method"},(0,i.kt)("inlineCode",{parentName:"a"},"VerifyNonMembership")," method"),"."),(0,i.kt)("li",{parentName:"ul"},"For ",(0,i.kt)("inlineCode",{parentName:"li"},"MigrateClientStoreMsg"),", see the section ",(0,i.kt)("a",{parentName:"li",href:"/main/ibc/light-clients/proposals#implementing-checksubstituteandupdatestate"},"Implementing ",(0,i.kt)("inlineCode",{parentName:"a"},"CheckSubstituteAndUpdateState")),".")),(0,i.kt)("h3",{id:"migration"},"Migration"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"08-wasm")," proxy light client exposes the ",(0,i.kt)("inlineCode",{parentName:"p"},"MigrateContract")," RPC endpoint that can be used to migrate a given Wasm light client contract (specified by the client identifier) to a new Wasm byte code (specified by the hash of the byte code). The expected use case for this RPC endpoint is to enable contracts to migrate to new byte code in case the current byte code is found to have a bug or vulnerability. The Wasm byte code that contracts are migrated have to be uploaded beforehand using ",(0,i.kt)("inlineCode",{parentName:"p"},"MsgStoreCode")," and must implement the ",(0,i.kt)("inlineCode",{parentName:"p"},"migrate")," entry point. See section",(0,i.kt)("a",{parentName:"p",href:"/main/ibc/light-clients/wasm/messages#msgmigratecontract"},(0,i.kt)("inlineCode",{parentName:"a"},"MsgMigrateContract"))," for information about the request messsage for this RPC endpoint. "),(0,i.kt)("h2",{id:"expected-behaviour"},"Expected behaviour"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"08-wasm")," proxy light client modules expects the following behaviour from the Wasm light client contracts when executing messages that perform state-changing writes:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The contract must not delete the client state from the store."),(0,i.kt)("li",{parentName:"ul"},"The contract must not change the client state to a client state of another type."),(0,i.kt)("li",{parentName:"ul"},"The contract must not change the checksum in the client state.")),(0,i.kt)("p",null,"Any violation of these rules will result in an error returned from ",(0,i.kt)("inlineCode",{parentName:"p"},"08-wasm")," that will abort the transaction."))}h.isMDXComponent=!0}}]);