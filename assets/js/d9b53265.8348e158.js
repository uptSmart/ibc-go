"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3150],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var l=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);t&&(l=l.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,l)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,l,o=function(e,t){if(null==e)return{};var n,l,o={},a=Object.keys(e);for(l=0;l<a.length;l++)n=a[l],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(l=0;l<a.length;l++)n=a[l],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=l.createContext({}),s=function(e){var t=l.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=s(e.components);return l.createElement(c.Provider,{value:t},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return l.createElement(l.Fragment,{},t)}},f=l.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,c=e.parentName,u=r(e,["components","mdxType","originalType","parentName"]),d=s(n),f=o,h=d["".concat(c,".").concat(f)]||d[f]||p[f]||a;return n?l.createElement(h,i(i({ref:t},u),{},{components:n})):l.createElement(h,i({ref:t},u))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=f;var r={};for(var c in t)hasOwnProperty.call(t,c)&&(r[c]=t[c]);r.originalType=e,r[d]="string"==typeof e?e:o,i[1]=r;for(var s=2;s<a;s++)i[s]=n[s];return l.createElement.apply(null,i)}return l.createElement.apply(null,n)}f.displayName="MDXCreateElement"},67097:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>a,metadata:()=>r,toc:()=>s});var l=n(87462),o=(n(67294),n(3905));const a={},i="ADR 004: Lock fee module upon escrow out of balance",r={unversionedId:"adr-004-ics29-lock-fee-module",id:"adr-004-ics29-lock-fee-module",title:"ADR 004: Lock fee module upon escrow out of balance",description:"Changelog",source:"@site/architecture/adr-004-ics29-lock-fee-module.md",sourceDirName:".",slug:"/adr-004-ics29-lock-fee-module",permalink:"/architecture/adr-004-ics29-lock-fee-module",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"defaultSidebar",previous:{title:"ADR 003: ICS27 Acknowledgement Format",permalink:"/architecture/adr-003-ics27-acknowledgement"},next:{title:"ADR 005: UpdateClient Events - ClientState Consensus Heights",permalink:"/architecture/adr-005-consensus-height-events"}},c={},s=[{value:"Changelog",id:"changelog",level:2},{value:"Status",id:"status",level:2},{value:"Context",id:"context",level:2},{value:"Decision",id:"decision",level:2},{value:"Sending side",id:"sending-side",level:3},{value:"Receiving side",id:"receiving-side",level:3},{value:"Consequences",id:"consequences",level:2},{value:"Positive",id:"positive",level:3},{value:"Negative",id:"negative",level:3},{value:"Neutral",id:"neutral",level:3},{value:"References",id:"references",level:2}],u={toc:s},d="wrapper";function p(e){let{components:t,...n}=e;return(0,o.kt)(d,(0,l.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"adr-004-lock-fee-module-upon-escrow-out-of-balance"},"ADR 004: Lock fee module upon escrow out of balance"),(0,o.kt)("h2",{id:"changelog"},"Changelog"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"03/03/2022: initial draft")),(0,o.kt)("h2",{id:"status"},"Status"),(0,o.kt)("p",null,"Accepted"),(0,o.kt)("h2",{id:"context"},"Context"),(0,o.kt)("p",null,"The fee module maintains an escrow account for all fees escrowed to incentivize packet relays.\nIt also tracks each packet fee escrowed separately from the escrow account. This is because the escrow account only maintains a total balance. It has no reference for which coins belonged to which packet fee.\nIn the presence of a severe bug, it is possible the escrow balance will become out of sync with the packet fees marked as escrowed.\nThe ICS29 module should be capable of elegantly handling such a scenario."),(0,o.kt)("h2",{id:"decision"},"Decision"),(0,o.kt)("p",null,'We will allow for the ICS29 module to become "locked" if the escrow balance is determined to be out of sync with the packet fees marked as escrowed.\nA "locked" fee module will not allow for packet escrows to occur nor will it distribute fees. All IBC callbacks will skip performing fee logic, similar to fee disabled channels.'),(0,o.kt)("p",null,"Manual intervention will be needed to unlock the fee module."),(0,o.kt)("h3",{id:"sending-side"},"Sending side"),(0,o.kt)("p",null,"Special behaviour will have to be accounted for in ",(0,o.kt)("inlineCode",{parentName:"p"},"OnAcknowledgementPacket"),". Since the counterparty will continue to send incentivized acknowledgements for fee enabled channels, the acknowledgement will still need to be unmarshalled into an incentivized acknowledgement before calling the underlying application ",(0,o.kt)("inlineCode",{parentName:"p"},"OnAcknowledgePacket")," callback."),(0,o.kt)("p",null,"When distributing fees, a cached context should be used. If the escrow account balance would become negative, the current state changes should be discarded and the fee module should be locked using the uncached context. This prevents fees from being partially distributed for a given packetID."),(0,o.kt)("h3",{id:"receiving-side"},"Receiving side"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"OnRecvPacket")," should remain unaffected by the fee module becoming locked since escrow accounts only affect the sending side."),(0,o.kt)("h2",{id:"consequences"},"Consequences"),(0,o.kt)("h3",{id:"positive"},"Positive"),(0,o.kt)("p",null,"The fee module can be elegantly disabled in the presence of severe bugs."),(0,o.kt)("h3",{id:"negative"},"Negative"),(0,o.kt)("p",null,"Extra logic is added to account for edge cases which are only possible in the presence of bugs."),(0,o.kt)("h3",{id:"neutral"},"Neutral"),(0,o.kt)("h2",{id:"references"},"References"),(0,o.kt)("p",null,"Issues:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/cosmos/ibc-go/issues/821"},"#821")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/cosmos/ibc-go/issues/860"},"#860"))),(0,o.kt)("p",null,"PR's:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/cosmos/ibc-go/pull/1031"},"#1031")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/cosmos/ibc-go/pull/1029"},"#1029")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/cosmos/ibc-go/pull/1056"},"#1056"))))}p.isMDXComponent=!0}}]);